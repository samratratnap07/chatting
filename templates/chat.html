<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nick & Saisha Chat</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
      /* ============== PHONE STYLE SQUARE BOX CSS ============== */
      .phone-square-container {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 140px;
        margin-top: 18px;
        margin-bottom: 8px;
      }

      .phone-square {
        position: relative;
        width: 205px;
        height: 68px;
        perspective: 900px;
      }
      .phone-square .base {
        width: 205px;
        height: 68px;
        background: linear-gradient(90deg, #211e2c 70%, #3c3453 100%);
        border-radius: 13px;
        border: 2px solid #444;
        box-shadow: 0 6px 22px #18133744;
        position: absolute;
        left: 0; top: 0;
        z-index: 1;
      }
      .phone-square .lid {
        width: 205px;
        height: 68px;
        background: linear-gradient(90deg, #3e3567 5%, #211e2c 80%);
        border-radius: 13px 13px 13px 13px;
        border: 2px solid #444;
        box-shadow: 0 2px 13px #3331;
        position: absolute;
        left: 0; top: 0;
        z-index: 2;
        transform-origin: bottom center;
        transition: transform 0.6s cubic-bezier(.7,1.8,.57,.91);
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .phone-square .birthday-message {
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 10px 0;
        width: 100%; height: 100%;
      }
      .phone-square .birthday-message p {
        font-size: 1rem;
        font-weight: bold;
        color: #ffdbfa;
        margin-bottom: 7px;
        text-shadow: 1px 2px 7px #1f1844, 0 0 2px #fff8;
      }
      #surpriseBtn {
        background: linear-gradient(88deg,#fe3dea,#00f0ff);
        color: #fff; font-weight: bold;
        border: none;
        padding: 8px 12px;
        border-radius: 9px;
        box-shadow: 0 2px 11px #38a1e522;
        cursor: pointer;
        transition: filter .15s;
      }
      #surpriseBtn:hover { filter: brightness(1.12);}
      /* ======= Flip Animation & Message show ======= */
      .phone-square.flipped .lid { transform: rotateX(180deg); }
      .phone-square.flipped .birthday-message { display: flex; }
    </style>
</head>
<body>
    <div class="bg-blur-lights"></div>
    <header>
        <span class="header-title">Nick & Saisha Chat</span>
        <form method="POST" action="/logout" style="margin:0;display:inline;">
            <button type="submit" class="logout-btn">Logout</button>
        </form>
    </header>

    <!-- PHONE STYLE SQUARE BOX START -->
    <div class="phone-square-container">
      <div class="phone-square" id="birthdaySquare">
        <div class="lid" id="squareLid">
          <div class="birthday-message" id="birthdayMessage">
            <p>Happy Birthday to You Bro</p>
            <!-- अपनी link नीचे डालें -->
            <button id="surpriseBtn" onclick="window.open('https://your-link-here.com')">Click Here</button>
          </div>
        </div>
        <div class="base"></div>
      </div>
    </div>
    <!-- PHONE STYLE SQUARE BOX END -->

    <div class="main-chat-wrapper">
        <div class="chat-box" id="chat-box"></div>
        <form id="chat-form">
            <input type="text" id="message" placeholder="Type a message..." autocomplete="off" required>
            <button type="submit">Send</button>
        </form>
    </div>
    <div id="edit-popup" style="display:none"></div>
    <script>
        // =============== PHONE-STYLE FLIP LOGIC ==============
        function triggerBirthdaySurprise() {
            document.getElementById('birthdaySquare').classList.add('flipped');
        }
        function resetBirthdaySurprise() {
            document.getElementById('birthdaySquare').classList.remove('flipped');
        }

        // <<== CHAT LOGIC SAME AS ORIGINAL (unchanged) ==>>
        const chatBox = document.getElementById("chat-box");
        const form = document.getElementById("chat-form");
        const messageInput = document.getElementById("message");
        const username = "{{ username }}";
        let editingMsgId = null;

        function scrollToBottom() {
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function createMsgActions(msgDiv, msgId, msgText) {
            msgDiv.querySelectorAll(".msg-actions").forEach(el=>el.remove());
            const actionsPopup = document.createElement("div");
            actionsPopup.className = "msg-actions";
            actionsPopup.innerHTML = `
                <button onclick="editMsgUI(${msgId}, this)">Edit</button>
                <button onclick="copyToClipboard('${msgText.replace(/'/g,"\\'")}')">Copy</button>
                <button onclick="deleteMsg(${msgId}, this)">Delete</button>
            `;
            msgDiv.appendChild(actionsPopup);
            setTimeout(() => actionsPopup.classList.add('show'), 15);
            return actionsPopup;
        }

        document.body.addEventListener('click', function(e){
            document.querySelectorAll(".msg-actions.show").forEach(el => {
                if(!el.parentNode.contains(e.target)) el.classList.remove("show");
            });
            const editPopup = document.getElementById('edit-popup');
            if(editPopup.style.display=='flex' && e.target===editPopup) editPopup.style.display='none';
        });

        function editMsgUI(msgId, btn) {
            document.querySelectorAll(".msg-actions.show").forEach(el=>el.classList.remove("show"));
            let msgBubble = btn.closest('.message').querySelector('.bubble');
            let oldText = msgBubble.innerText;
            const editPopup = document.getElementById('edit-popup');
            editPopup.style.display='flex';
            editPopup.innerHTML = `
                <div class="edit-popup">
                    <div class="edit-box">
                      <b>Edit Message</b>
                      <input type="text" id="edit-msg-input" value="${oldText.replace(/"/g,'&quot;')}">
                      <div class="actions">
                        <button onclick="submitEdit(${msgId})">Save</button>
                        <button onclick="document.getElementById('edit-popup').style.display='none'">Cancel</button>
                      </div>
                    </div>
                </div>
            `;
            setTimeout(() => document.getElementById('edit-msg-input').focus(),60);
        }
        function submitEdit(msgId){
            const newText = document.getElementById('edit-msg-input').value;
            fetch("/edit", {
                method:"POST",
                headers: {"Content-Type":"application/json"},
                body: JSON.stringify({msg_id:msgId, new_text:newText})
            }).then(r=>r.json())
             .then(res=>{
                document.getElementById('edit-popup').style.display='none';
                loadMessages();
             });
        }
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text);
            alert('Message copied!');
        }
        function deleteMsg(msgId, btn){
            fetch("/delete",{
                method:"POST",
                headers: {"Content-Type":"application/json"},
                body: JSON.stringify({msg_id:msgId})
            }).then(r=>r.json())
              .then(res=>{
                loadMessages();
              });
        }

        // ------------- Surprise Message Checker -------------
        function checkForSurprise(messages) {
            for (let i = messages.length - 1; i >= Math.max(0, messages.length - 10); --i) {
                const msg = messages[i].message || '';
                if (msg.toLowerCase().includes("surprise pesh kiya jaye")) {
                    triggerBirthdaySurprise();
                    return;
                }
            }
            resetBirthdaySurprise();
        }

        function loadMessages() {
            fetch("/messages")
                .then(res => res.json())
                .then(data => {
                    chatBox.innerHTML = "";
                    data.messages.forEach((msg, idx) => {
                        let msgDiv = document.createElement("div");
                        msgDiv.classList.add("message");
                        msgDiv.classList.add(msg.sender === username ? "sent" : "received");
                        msgDiv.innerHTML = `
                            <div class="username">${msg.sender}</div>
                            <div class="bubble">${msg.message}</div>
                            <div class="timestamp">${msg.timestamp}</div>
                        `;
                        const msgId = msg.id !== undefined ? msg.id : idx;
                        msgDiv.onclick = function(e){
                            createMsgActions(msgDiv, msgId, msg.message);
                            e.stopPropagation();
                        };
                        chatBox.appendChild(msgDiv);
                    });
                    scrollToBottom();
                    checkForSurprise(data.messages);
                });
        }
        form.addEventListener("submit", e => {
            e.preventDefault();
            const text = messageInput.value.trim();
            if (!text) return;
            fetch("/send", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({message: text})
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    messageInput.value = "";
                    loadMessages();
                }
            });
        });
        setInterval(loadMessages, 2000);
        loadMessages();
    </script>
</body>
</html>
