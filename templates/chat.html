<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nick & Saisha Chat</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="bg-blur-lights"></div>
    <header>
        <span class="header-title">Nick & Saisha Chat</span>
        <form method="POST" action="/logout" style="margin:0;display:inline;">
            <button type="submit" class="logout-btn">Logout</button>
        </form>
    </header>
  <!-- Flip Card Animation START -->
<div class="flip-card-wrapper">
  <div class="flip-card">
    <div class="flip-card-inner">
      <!-- Front Side -->
      <div class="flip-card-front"></div>
      <!-- Back Side -->
      <div class="flip-card-back">
        <h2>This is the end</h2>
        <button class="end-btn" onclick="window.open('https://your-link-here.com', '_self')">
          Continue
        </button>
      </div>
    </div>
  </div>
</div>
<!-- Flip Card Animation END -->

    <div class="main-chat-wrapper">
        <div class="chat-box" id="chat-box"></div>
        <form id="chat-form">
            <input type="text" id="message" placeholder="Type a message..." autocomplete="off" required>
            <button type="submit">Send</button>
        </form>
    </div>
    <div id="edit-popup" style="display:none"></div>
    <script>
        const chatBox = document.getElementById("chat-box");
        const form = document.getElementById("chat-form");
        const messageInput = document.getElementById("message");
        const username = "{{ username }}";
        let editingMsgId = null;

        function scrollToBottom() {
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // UI: Create action/popup menu
        function createMsgActions(msgDiv, msgId, msgText) {
            msgDiv.querySelectorAll(".msg-actions").forEach(el=>el.remove());
            const actionsPopup = document.createElement("div");
            actionsPopup.className = "msg-actions";
            actionsPopup.innerHTML = `
                <button onclick="editMsgUI(${msgId}, this)">Edit</button>
                <button onclick="copyToClipboard('${msgText.replace(/'/g,"\\'")}')">Copy</button>
                <button onclick="deleteMsg(${msgId}, this)">Delete</button>
            `;
            msgDiv.appendChild(actionsPopup);
            setTimeout(() => actionsPopup.classList.add('show'), 15);
            return actionsPopup;
        }

        // Message menu will NOT autoclose by itself; only close when user clicks elsewhere:
        document.body.addEventListener('click', function(e){
            document.querySelectorAll(".msg-actions.show").forEach(el => {
                if(!el.parentNode.contains(e.target)) el.classList.remove("show");
            });
            // Edit popup autoclose if click background
            const editPopup = document.getElementById('edit-popup');
            if(editPopup.style.display=='flex' && e.target===editPopup) editPopup.style.display='none';
        });

        function editMsgUI(msgId, btn) {
            document.querySelectorAll(".msg-actions.show").forEach(el=>el.classList.remove("show"));
            let msgBubble = btn.closest('.message').querySelector('.bubble');
            let oldText = msgBubble.innerText;
            const editPopup = document.getElementById('edit-popup');
            editPopup.style.display='flex';
            editPopup.innerHTML = `
                <div class="edit-popup">
                    <div class="edit-box">
                      <b>Edit Message</b>
                      <input type="text" id="edit-msg-input" value="${oldText.replace(/"/g,'&quot;')}">
                      <div class="actions">
                        <button onclick="submitEdit(${msgId})">Save</button>
                        <button onclick="document.getElementById('edit-popup').style.display='none'">Cancel</button>
                      </div>
                    </div>
                </div>
            `;
            setTimeout(() => document.getElementById('edit-msg-input').focus(),60);
        }
        function submitEdit(msgId){
            const newText = document.getElementById('edit-msg-input').value;
            // Dummy Ajax request; replace with backend logic
            fetch("/edit", {
                method:"POST",
                headers: {"Content-Type":"application/json"},
                body: JSON.stringify({msg_id:msgId, new_text:newText})
            }).then(r=>r.json())
             .then(res=>{
                document.getElementById('edit-popup').style.display='none';
                loadMessages();
             });
        }
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text);
            alert('Message copied!');
        }
        function deleteMsg(msgId, btn){
            // Dummy function! Backend required.
            fetch("/delete",{
                method:"POST",
                headers: {"Content-Type":"application/json"},
                body: JSON.stringify({msg_id:msgId})
            }).then(r=>r.json())
              .then(res=>{
                loadMessages();
              });
        }

        // Render messages (sample ids used for demo)
        function loadMessages() {
            fetch("/messages")
                .then(res => res.json())
                .then(data => {
                    chatBox.innerHTML = "";
                    data.messages.forEach((msg, idx) => {
                        let msgDiv = document.createElement("div");
                        msgDiv.classList.add("message");
                        msgDiv.classList.add(msg.sender === username ? "sent" : "received");
                        msgDiv.innerHTML = `
                            <div class="username">${msg.sender}</div>
                            <div class="bubble">${msg.message}</div>
                            <div class="timestamp">${msg.timestamp}</div>
                        `;
                        const msgId = msg.id !== undefined ? msg.id : idx; // using idx if no id field
                        msgDiv.onclick = function(e){
                            // Open popup menu on single click
                            createMsgActions(msgDiv, msgId, msg.message);
                            e.stopPropagation();
                        };
                        chatBox.appendChild(msgDiv);
                    });
                    scrollToBottom();
                });
        }
        form.addEventListener("submit", e => {
            e.preventDefault();
            const text = messageInput.value.trim();
            if (!text) return;
            fetch("/send", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({message: text})
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    messageInput.value = "";
                    loadMessages();
                }
            });
        });
        setInterval(loadMessages, 2000);
        loadMessages();
    </script>
</body>
</html>
